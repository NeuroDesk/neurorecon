name: build-apps

on:
  workflow_call:
    inputs:
      applications:
        required: true
        type: string

env:
  RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}

jobs:
  build:
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        application: ${{ fromJSON(inputs.applications) }}
    outputs:
      BUILDDATE: ${{ steps.ENVVARS.outputs.BUILDDATE }}
      IMAGENAME: ${{ steps.IMAGEVARS.outputs.IMAGENAME }}
    steps:
      - uses: actions/checkout@v4
      - name: Set environment variables
        id: ENVVARS
        run: |
          APPLICATION=${{ matrix.application }}
          BUILDDATE=`date +%Y%m%d`
          echo "APPLICATION=$APPLICATION" >> $GITHUB_ENV
          echo "BUILDDATE=$BUILDDATE" >> $GITHUB_ENV
      - name: Build recipes
        run: |
          echo "APPLICATION: $APPLICATION"
          cd recipes/$APPLICATION
          echo `which python`
          /bin/bash ../build.sh
      - name: Setup rclone
        run: |
          mkdir -p ~/.config/rclone
          if [ ! -f ~/.config/rclone/rclone.conf ]; then
            echo "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf
          fi
      - name: Set image variables
        id: IMAGEVARS
        run: |
          echo "finding zip file for $APPLICATION:"
          ZIPFILE=`find ./recipes/$APPLICATION -type f -iname "OpenRecon_*_$APPLICATION_*.zip" | head -1`
          echo "ZIPFILE: $ZIPFILE"
          IMAGENAME=$(echo $(basename $ZIPFILE .zip))
          echo "IMAGENAME: $IMAGENAME"
          echo "IMAGENAME=$IMAGENAME" >> $GITHUB_ENV
      - name : Upload zip file
        run: /bin/bash .github/workflows/upload-zip.sh $ZIPFILE
